# Эпик: Режим обслуживания (MVP)

## 1) Контекст текущей реализации (опорные факты)
- **Бэкенд:** Express, маршруты в `server/routes.ts` и `server/routes/*`, подключение через `registerRoutes()` → `registerRouteModules()`.
- **Админка:** UI `/admin/*` (см. `client/src/App.tsx`, меню в `client/src/components/AdminSidebar.tsx`).
- **Роли:** глобальные `admin | user`; роли воркспейса `owner | manager | user`.
- **Системные настройки:** singleton‑настройки (SMTP/индексация) — `server/smtp-settings.ts`, `server/indexing-rules.ts`.
- **Клиент:** запросы через `apiRequest` (`client/src/lib/queryClient.ts`).

## 2) Цель
Сделать **простую базовую версию режима обслуживания** для релизов:
- заранее предупреждать пользователей о плановом релизе;
- полностью закрывать прод на время релиза;
- обеспечить администратору быстрый контроль над режимом.

## 3) Бизнес‑проблемы, которые решаем
- Пользователь получает непредсказуемые ошибки при релизе.
- Нет централизованного механизма «закрытия» продукта.
- Нет единого сообщения/страницы обслуживания.

## 4) Границы эпика
### Входит (MVP)
- Плановое обслуживание (задание интервала заранее).
- Экстренное включение режима (немедленно).
- **Полная недоступность** продукта (full maintenance).
- Баннер‑предупреждение до начала.
- Экран обслуживания во время активного режима.
- Блокировка входа во время активного режима.
- Журнал действий администратора.

### Не входит (отложено)
- Частичная доступность (read‑only режим).
- Пер‑воркспейс режим обслуживания.
- Внешние уведомления (email/мессенджеры).
- Управление уже запущенными фоновыми процессами.

## 5) Ключевые пользовательские сценарии (кратко)
- Плановое обслуживание: баннер → автоматическое включение.
- Экстренное включение режима администратором.
- Пользователь уже в системе в момент включения.
- Вход в систему заблокирован во время активного режима.

Полные сценарии в `docs/epics/maintenance-mode/user-scenarios.md`.

## 6) Роли и поведение
- **Гость:** видит баннер и экран обслуживания; вход недоступен во время активного режима.
- **Участник воркспейса (`user`) / администратор воркспейса (`owner`/`manager`)**: экран обслуживания во время активного режима.
- **Администратор системы (`admin`)**: может управлять режимом **при наличии активной сессии**; вход также блокируется.

## 7) Критерии успешности
- Статус режима доступен клиенту и серверу не позднее **1 минуты** после изменения.
- Все запросы (кроме allowlist) возвращают 503 + `errorCode=MAINTENANCE_MODE`.
- Вход блокируется во время активного режима.
- Все админ‑изменения фиксируются в журнале.

## 8) Зависимости и риски
- **Зависимость:** корректная защита `/api/admin/*` через `requireAdmin`.
- **Риск:** администратор без активной сессии не сможет выключить режим (нужен ручной fallback).
- **Риск:** рассинхрон времени клиента/сервера при показе сообщений.

## 9) Состав комплекта документов
- `docs/epics/maintenance-mode/user-scenarios.md`
- `docs/epics/maintenance-mode/admin-settings-requirements.md`
- `docs/epics/maintenance-mode/ui-requirements.md`
- `docs/epics/maintenance-mode/server-logic.md`
- `docs/epics/maintenance-mode/non-functional-requirements.md`
- `docs/epics/maintenance-mode/implementation-tasks.md`
- `docs/epics/maintenance-mode/test-scenarios.md`
