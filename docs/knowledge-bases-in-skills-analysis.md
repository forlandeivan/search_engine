# Анализ работы баз знаний в навыках

## Текущее состояние

### Архитектура

#### 1. База данных

**Таблица связи навыков и баз знаний:**
- `skill_knowledge_bases` - связующая таблица (many-to-many)
  - `skill_id` → `skills.id`
  - `knowledge_base_id` → `knowledge_bases.id`
  - `workspace_id` → `workspaces.id`

**Поля навыка, связанные с RAG:**
- `mode` - тип навыка: `"rag"` | `"llm"` (по умолчанию `"rag"`, но при создании определяется автоматически)
- `execution_mode` - режим выполнения: `"standard"` | `"no_code"` (по умолчанию `"standard"`)
- `rag_mode` - режим использования коллекций: `"all_collections"` | `"selected_collections"`
- `rag_collection_ids` - массив ID коллекций (если `rag_mode = "selected_collections"`)
- Множество других `rag_*` полей для настройки RAG

#### 2. Логика определения типа навыка

**Автоматическое определение `mode`:**
- При создании/обновлении навыка (`server/skills.ts`):
  - Если есть `knowledgeBaseIds` → `mode = "rag"`
  - Если нет `knowledgeBaseIds` → `mode = "llm"`
- В `SkillSettingsPage.tsx` (строка 348):
  - Если `executionMode = "no_code"` → `mode = "llm"`
  - Если есть источники RAG (базы знаний или коллекции) → `mode = "rag"`
  - Иначе → `mode = "llm"`

**Проверка типа навыка:**
- `server/skill-type.ts:isRagSkill()` - проверяет `mode === "rag"`
- Используется в `server/chat-service.ts` для определения типа навыка

#### 3. Использование в чатах

**Процесс обработки сообщения (`server/routes.ts:12929`):**
1. Создается контекст чата через `buildChatLlmContext()`
2. Проверяется `context.skill.isRagSkill`
3. Если `isRagSkill = true`:
   - Вызывается `callRagForSkillChat()` → `buildSkillRagRequestPayload()`
   - Используется первая база знаний из `skill.knowledgeBaseIds[0]`
   - Запускается RAG-пайплайн через `runKnowledgeBaseRagPipeline()`
4. Если `isRagSkill = false`:
   - Используется стандартный LLM-чат без RAG
   - Источник знаний - только файлы навыка из workspace-коллекции

**Важно:** RAG работает независимо от `executionMode`! Если `mode = "rag"`, то RAG используется даже при `executionMode = "standard"`.

#### 4. Проблема в UI (РЕШЕНА)

**Где был скрыт выбор баз знаний (исправлено):**

1. ✅ **SkillsPage.tsx (строка 1967):** 
   - **Было:** `{executionMode !== "standard" && (`
   - **Стало:** `{executionMode !== "no_code" && (`
   - Выбор баз знаний теперь доступен для стандартного режима

2. ✅ **SkillsPage.tsx (строки 1396-1407):**
   - **Было:** `useEffect` который автоматически очищал базы знаний при `executionMode = "standard"`
   - **Стало:** useEffect убран, базы знаний не очищаются автоматически

3. ✅ **SkillSettingsPage.tsx:**
   - Передает `knowledgeBaseIds` в payload (строка 346)
   - Форма теперь показывает выбор баз знаний для standard режима

### Разделение понятий

**Два независимых параметра:**

1. **`executionMode`** - как выполняется навык:
   - `"standard"` - через файлы навыка и workspace-коллекцию
   - `"no_code"` - через внешний API (no-code интеграция)

2. **`mode`** - откуда брать знания для RAG:
   - `"rag"` - из баз знаний (через RAG-пайплайн)
   - `"llm"` - только LLM без RAG (только файлы навыка)

**Проблема:** UI смешивает эти два понятия и скрывает выбор баз знаний для `executionMode = "standard"`, хотя они должны работать независимо.

### Текущая логика работы

**Стандартный режим (`executionMode = "standard"`):**
- По умолчанию `mode = "llm"` (если нет баз знаний)
- Использует только файлы навыка из workspace-коллекции
- RAG-настройки игнорируются
- Базы знаний не используются (даже если указаны)

**RAG режим (`mode = "rag"`):**
- Работает независимо от `executionMode`
- Использует базы знаний из `knowledgeBaseIds`
- Запускает RAG-пайплайн через `callRagForSkillChat()`
- Использует настройки из `ragConfig`

**No-code режим (`executionMode = "no_code"`):**
- Всегда `mode = "llm"` (строка 348 в SkillSettingsPage.tsx)
- Базы знаний не используются
- Работает через внешний API

### Что нужно исправить

1. **UI должен показывать выбор баз знаний для `mode = "rag"`, независимо от `executionMode`**
2. **Убрать автоматическую очистку баз знаний при `executionMode = "standard"`**
3. **Разделить логику отображения:**
   - Показывать выбор баз знаний, если навык может быть в режиме RAG
   - Не очищать базы знаний автоматически при изменении `executionMode`

### Документация

**mode-boundary-contract.md:**
- Описывает разделение между Standard и KB/Nocode режимами
- Указывает, что KB UI скрыт из стандартной формы навыка
- Но это устаревшая информация - нужно обновить

### API и эндпоинты

**RAG-пайплайн:**
- `server/chat-rag.ts:buildSkillRagRequestPayload()` - строит запрос для RAG
- Требует: `knowledgeBaseIds[0]`, `ragConfig.embeddingProviderId`, `llmProviderConfigId`, `modelId`
- Использует настройки из `knowledgeBaseSearchSettings` (слияние с настройками навыка)

**Эндпоинты:**
- `POST /api/chat/sessions/:chatId/messages/llm` - обработка сообщений
- Внутри проверяется `isRagSkill` и вызывается RAG-пайплайн при необходимости

### Выводы

1. **Базы знаний работают на бэкенде** - логика полностью реализована
2. **Проблема только в UI** - выбор баз знаний скрыт для standard режима
3. **Нужно исправить условия отображения** - показывать выбор баз знаний для навыков, которые могут использовать RAG
4. **Разделить логику** - `executionMode` и `mode` должны работать независимо

### Выполненные изменения

**Эпик: 2-epic-knowledge-bases-in-skills**

#### Стори 1: Восстановление выбора баз знаний
- ✅ Убрано условие `executionMode !== "standard"` для отображения выбора баз знаний
- ✅ Убрана автоматическая очистка баз знаний при изменении `executionMode`
- ✅ Выбор баз знаний теперь доступен для всех навыков, кроме no-code
- ✅ Убрана логика очистки баз знаний в `handleSubmit` для standard режима

#### Стори 2: Автоматическое определение режима
- ✅ Добавлен `useEffect` для автоматического определения режима при изменении баз знаний и коллекций
- ✅ Навык автоматически переключается в RAG-режим при выборе базы знаний
- ✅ Навык автоматически переключается в LLM-режим при удалении всех баз знаний (если нет коллекций)
- ✅ Обновлена логика в `handleSubmit` для автоматического определения режима

#### Стори 3: Разделение логики режимов
- ✅ Разделена логика отображения для `executionMode` и `mode`
- ✅ RAG-настройки показываются при `mode = "rag"` или при наличии баз знаний/коллекций, независимо от `executionMode`
- ✅ Обновлено описание секции "Источники и коллекции" с информацией о режиме RAG
- ✅ Улучшен UX - понятно, когда навык использует базы знаний

#### Стори 4: Обновление документации
- ✅ Обновлена документация `mode-boundary-contract.md`
- ✅ Обновлен анализ `knowledge-bases-in-skills-analysis.md`

### Текущее состояние (после исправлений)

**Стандартный режим (`executionMode = "standard"`):**
- Может использовать базы знаний при `mode = "rag"`
- Выбор баз знаний доступен в UI
- При выборе базы знаний автоматически устанавливается `mode = "rag"`
- RAG-настройки показываются при `mode = "rag"`

**RAG режим (`mode = "rag"`):**
- Работает независимо от `executionMode`
- Использует базы знаний из `knowledgeBaseIds`
- Запускает RAG-пайплайн через `callRagForSkillChat()`
- Использует настройки из `ragConfig`

**No-code режим (`executionMode = "no_code"`):**
- Всегда `mode = "llm"`
- Базы знаний не используются
- Работает через внешний API

