# Безопасность импорта архивов

## Обзор

При импорте архивов (ZIP, RAR, 7z) реализованы меры безопасности для защиты от различных типов атак.

## Реализованные меры защиты

### 1. Защита от Path Traversal (Zip Slip)

**Проблема:** Злоумышленник может создать архив с путями вида `../../etc/passwd`, которые при распаковке могут выйти за пределы целевой директории.

**Защита:**
- ✅ Нормализация всех путей (замена `\` на `/`)
- ✅ Отклонение абсолютных путей (начинающихся с `/`)
- ✅ Отклонение путей Windows (начинающихся с `C:`, `D:` и т.д.)
- ✅ Отклонение сегментов с `..` (path traversal)
- ✅ Фильтрация недопустимых символов (null-байты)

**Реализация:** Функция `sanitizePathSegments()` в `client/src/lib/archive-import.ts`

### 2. Ограничение размера архива

**Проблема:** Большие архивы могут вызвать переполнение памяти или DoS-атаку.

**Защита:**
- ✅ Максимальный размер архива: **500 МБ**
- ✅ Проверка выполняется до начала обработки

**Константа:** `MAX_ARCHIVE_SIZE = 500 * 1024 * 1024`

### 3. Ограничение размера отдельных файлов

**Проблема:** Один большой файл может вызвать переполнение памяти.

**Защита:**
- ✅ Максимальный размер файла: **20 МБ**
- ✅ Проверка выполняется для каждого файла перед обработкой

**Константа:** `MAX_FILE_SIZE = 20 * 1024 * 1024`

### 4. Защита от Zip Bomb атак

**Проблема:** Архив может содержать огромное количество маленьких файлов, что приведет к исчерпанию ресурсов.

**Защита:**
- ✅ Максимальное количество файлов в архиве: **10,000**
- ✅ Проверка выполняется до начала обработки всех файлов

**Константа:** `MAX_TOTAL_FILES = 10000`

### 5. Ограничение глубины вложенности

**Проблема:** Слишком глубокая вложенность папок может вызвать проблемы с производительностью и переполнение стека.

**Защита:**
- ✅ Максимальная глубина вложенности: **50 уровней**
- ✅ Проверка выполняется при валидации путей

**Константа:** `MAX_PATH_DEPTH = 50`

### 6. Ограничение длины имени файла

**Проблема:** Слишком длинные имена файлов могут вызвать проблемы в файловой системе и переполнение буферов.

**Защита:**
- ✅ Максимальная длина имени файла/папки: **255 символов**
- ✅ Проверка выполняется для каждого сегмента пути

**Константа:** `MAX_FILENAME_LENGTH = 255`

### 7. Валидация типов файлов

**Проблема:** В архиве могут быть исполняемые файлы, скрипты или другие опасные типы файлов.

**Защита:**
- ✅ Разрешены только поддерживаемые типы документов:
  - `.pdf`, `.doc`, `.docx`, `.pptx`, `.xlsx`
  - `.txt`, `.md`, `.markdown`, `.html`, `.htm`
  - `.eml`, `.csv`
- ✅ Файлы с неподдерживаемыми расширениями игнорируются
- ⚠️ **Ограничение:** Проверка выполняется только по расширению, не по MIME-типу

**Список:** `SUPPORTED_DOCUMENT_EXTENSIONS` в `client/src/lib/document-import.ts`

### 8. Защита от дубликатов

**Проблема:** Один и тот же файл может быть обработан несколько раз.

**Защита:**
- ✅ Отслеживание уже обработанных путей
- ✅ Дубликаты игнорируются с записью в ошибки

## Ограничения и рекомендации

### Текущие ограничения

1. **Проверка MIME-типов:** В текущей реализации проверка выполняется только по расширению файла, а не по реальному MIME-типу. Это означает, что файл с расширением `.txt` может быть на самом деле исполняемым файлом.

2. **Обработка на клиенте:** Вся обработка архивов происходит на клиенте (в браузере), что означает:
   - Ограничения памяти браузера
   - Нет возможности использовать серверные инструменты (libmagic, антивирусы)
   - Нет изоляции (sandbox) для обработки

3. **Нет проверки на вирусы:** Система не проверяет архивы на наличие вирусов или вредоносного ПО.

### Рекомендации для улучшения

1. **Добавить проверку MIME-типов:**
   - Использовать библиотеку для определения реального типа файла
   - Сравнивать с расширением
   - Отклонять файлы с несоответствием

2. **Перенести обработку на сервер:**
   - Обработка архивов в изолированной среде (sandbox)
   - Использование серверных инструментов для валидации
   - Возможность сканирования на вирусы

3. **Добавить аудит-логирование:**
   - Логировать все отклоненные файлы
   - Логировать попытки path traversal
   - Мониторинг подозрительной активности

4. **Добавить rate limiting:**
   - Ограничение количества импортов на пользователя
   - Ограничение частоты импортов

5. **Добавить проверку содержимого:**
   - Проверка на наличие опасных паттернов в текстовых файлах
   - Валидация структуры документов
   - Проверка на скрытые данные (steganography)

## Примеры атак и защита

### Пример 1: Path Traversal
```
Архив содержит: ../../etc/passwd
Результат: Файл отклонен (путь содержит ..)
```

### Пример 2: Zip Bomb
```
Архив содержит: 50,000 маленьких файлов
Результат: Архив отклонен (превышен лимит в 10,000 файлов)
```

### Пример 3: Большой файл
```
Архив содержит: file.pdf (50 МБ)
Результат: Файл отклонен (превышен лимит в 20 МБ)
```

### Пример 4: Исполняемый файл
```
Архив содержит: script.exe
Результат: Файл игнорирован (расширение .exe не поддерживается)
```

## Заключение

Текущая реализация обеспечивает базовую защиту от наиболее распространенных атак на обработку архивов. Однако для production-окружения рекомендуется:

1. Перенести обработку на сервер
2. Добавить проверку MIME-типов
3. Добавить сканирование на вирусы
4. Улучшить аудит и мониторинг
