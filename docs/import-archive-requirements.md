# Требования к функции «Импорт архива»

## Обзор

Функция «Импорт архива» позволяет пользователю загрузить ZIP-файл и автоматически развернуть его содержимое в структуре текущей Базы знаний (KB). Сервис должен безопасно распаковывать файлы, обеспечивать масштабируемость для больших архивов и предоставлять прозрачный UX со статусами и логами обработки.

## Поддерживаемые сценарии

1. Пользователь выбирает ZIP-архив и запускает импорт.
2. Система загружает архив с поддержкой возобновления загрузки (resumable uploads).
3. После завершения загрузки создаётся Job в контексте текущей KB, который проходит статусы `Queued → Running → Completed/Failed`.
4. Job распаковывает архив, валидирует пути, создаёт дерево разделов/коллекций и документы для каждого файла.
5. Пользователь отслеживает прогресс, просматривает логи и может повторно запустить обработку только для файлов с ошибками.
6. После завершения импортированные данные доступны в KB с сохранённой иерархией, пользователь получает CTA «Перейти к KB».

## Требования к UX

### Карточка «Импорт архива»
- Выбор ZIP-файла через стандартный диалог.
- Отображение статуса подключения к механизму возобновляемой загрузки (например, tus или S3 multipart).
- Кнопка «Импортировать», активная после выбора файла и успешной инициализации соединения.

### Страница Job
- Прогресс-бар с процентами выполнения на основе количества обработанных файлов или байтов.
- Таблица/список логов с разбивкой на успешно обработанные и с ошибками, отображение типа ошибки и пути файла.
- Кнопка «Повторить только ошибки» запускает повторный Job, который переобрабатывает только неудачные элементы исходного импорта.
- После успешного завершения — CTA «Перейти к KB».

### Представление в KB
- Иерархия разделов строится из путей файлов: например, `/Маркетинг/Брендбук/brand.pdf` → раздел «Маркетинг» → подраздел «Брендбук» → документ `brand.pdf`.
- Документы получают извлечённый текст и метаданные (название, оригинальный путь, дата изменения и т.д.).
- Ошибочные файлы помечаются и не создаются в KB до успешной повторной обработки.

## Требования к функциональности

### Загрузка и хранение архива
- Использовать протокол с поддержкой возобновляемой загрузки (tus, S3 multipart upload или аналог).
- Ограничить максимальный размер архива конфигурируемым параметром, возвращать ошибку до начала обработки при превышении лимита.
- После загрузки сохранять архив во временное хранилище, привязанное к Job и ограниченное sandbox-директорией.

### Безопасность при распаковке
- Определять реальный MIME-типа каждого файла с помощью `libmagic` или аналогичного инструмента, не доверяя расширению.
- Поддерживаемые типы: `.pdf`, `.docx`, `.pptx`, `.xlsx`, `.txt`, `.md`, `.html`, `.eml`, `.csv`.
- При обнаружении неподдерживаемого формата — записывать ошибку в лог и не останавливать весь Job.
- Реализовать защиту от Zip Slip / path traversal:
  - Нормализовать пути при распаковке.
  - Отклонять записи, содержащие `..`, абсолютные пути или ведущие к выходу за пределы `sandboxDir`.
  - Запрещать создание симлинков и не извлекать атрибуты, уводящие за пределы целевой директории.
- Вести аудит-лог опасных попыток для дальнейшего мониторинга.

### Обработка документов
- Для каждого файла создавать запись документа в KB с:
  - Названием (имя файла без пути).
  - Полным оригинальным путём для восстановления иерархии.
  - Извлечённым текстом (использовать существующие конвейеры OCR/текстоизвлечения, если применимо).
  - Метаданными (размер, дата изменения, тип контента).
- Поддерживать параллельную обработку файлов с контролем нагрузки (конфигурируемый пул воркеров).
- Обработку каждого файла вести атомарно: успех — документ создаётся; ошибка — запись в лог и пометка для повторной обработки.

### Управление Job
- Хранить сущность Job с полями: `id`, `kbId`, `status`, `progress`, `totalItems`, `processedItems`, `failedItems`, `createdAt`, `updatedAt`, `errorSummary`.
- При старте распаковки рассчитывать `totalItems` (количество файлов в ZIP после фильтрации поддерживаемых типов).
- Обновлять `progress` на основе `processedItems / totalItems`.
- Для ошибок хранить структуру `filePath`, `errorType`, `message`, `retryCount`.
- Предусмотреть API для повторного запуска Job с фильтрацией по ошибочным файлам.
- Реализовать тайм-ауты и автоматические ретраи на сетевые/временные ошибки.

### Масштабируемость и устойчивость
- Job должен быть идемпотентным: повторный запуск не создаёт дубликатов документов.
- Хранить состояние обработки в БД, чтобы в случае падения сервиса Job можно было возобновить с последнего обработанного файла.
- Для больших архивов предусмотреть потоковую распаковку и обработку без полного извлечения на диск (где возможно) либо ограничивать использование дискового пространства.
- Лимитировать параллельные Job'ы на KB и глобально (конфигурируемо).
- Собрать метрики (время обработки, размер архива, количество ошибок) и алерты на массовые сбои.

## API и интеграция

### Эндпоинты
1. `POST /kb/:id/import-archive/upload` — инициализация возобновляемой загрузки, возвращает URL/токен для tus или S3 multipart.
2. `POST /kb/:id/import-archive` — завершение загрузки и постановка Job в очередь. Параметры: идентификатор загруженного архива, настройки парсинга (язык OCR, тайм-ауты и т.п.).
3. `GET /kb/:id/jobs/:jobId` — получение статуса Job, прогресса и логов.
4. `POST /kb/:id/jobs/:jobId/retry-failures` — повторная обработка файлов с ошибками.

### Webhooks/Realtime
- Использовать websockets или server-sent events для обновления UI прогрессом в реальном времени.
- Альтернативно — периодическое опрос API с разумным интервалом (5–10 секунд).

## Ошибки и состояния
- Валидационные ошибки (неправильный формат файла, превышение размера) отображаются в интерфейсе до запуска Job.
- Ошибки обработки отдельных файлов не приводят к отмене всего Job, но уменьшают прогресс и отображаются в разделе ошибок.
- Глобальные ошибки (внутренние сбои) переводят Job в статус `Failed` и предоставляют пользователю инструкции по повторному запуску.

## Нефункциональные требования
- Соответствие требованиям безопасности: санитизация путей, защита от RCE при обработке офисных форматов (использование sandboxed сервисов для извлечения текста).
- Локализация UI (многоязычность, в том числе поддержка русского и английского интерфейса).
- Логирование действий пользователя и системных ошибок для аудита.
- Покрытие автоматическими тестами: юнит-тесты проверки path traversal, интеграционные тесты загрузки/обработки, e2e-тест сценария импорта.

## Открытые вопросы
- Максимальный размер архива и политика хранения временных файлов.
- Дополнительные форматы (например, изображения) и необходимость OCR по умолчанию.
- SLA по времени обработки и очередей.
- Политика очистки архивов и временных данных после завершения Job.

