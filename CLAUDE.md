# ⚠️ КРИТИЧЕСКИ ВАЖНО: Правила для поддержания актуальности документации и тест-кейсов

**ЭТИ ПРАВИЛА ДОЛЖНЫ ВСЕГДА БЫТЬ В КОНТЕКСТЕ ПРИ РАБОТЕ С КОДОМ**

Эти правила также добавлены в `docs/agent-instructions.md` для гарантированного присутствия в контексте.

## ⚠️ КРИТИЧЕСКИ ВАЖНО: РАБОТА С ФАЙЛАМИ ДОКУМЕНТАЦИИ

**НИКОГДА не создавай дубликаты файлов документации!**

### При работе с файлами в Releases/ (стори, планы, документация):

1. **ВСЕГДА редактируй СУЩЕСТВУЮЩИЕ файлы, а не создавай новые**
   - Если файл уже существует (например, `1-us-выбор-баз-знаний-DONE.md`), редактируй ЕГО
   - НЕ создавай файлы без суффикса `-DONE`, если уже есть файл с `-DONE`
   - **КРИТИЧНО:** При переименовании используй ТОЛЬКО `mv` или `run_terminal_cmd` с `mv`, НИКОГДА не используй `write` для создания файла с новым именем

2. **Правило работы со стори-документами:**
   - Если файл существует → редактировать существующий (используй `search_replace` или `read_file` + `search_replace`)
   - Если файла нет → создать новый (используй `write`)
   - **При завершении стори:**
     - СНАЧАЛА обновить критерии готовности в существующем файле через `search_replace`
     - ЗАТЕМ переименовать файл в `-DONE.md` ТОЛЬКО через `run_terminal_cmd` с командой `mv`
     - **ЗАПРЕЩЕНО:** использовать `write` для создания файла с `-DONE` в названии

3. **Проверка перед созданием/переименованием файла:**
   - **Перед созданием:** проверить через `list_dir` или `glob_file_search`, нет ли уже файла с таким именем (с `-DONE` или без)
   - **Перед переименованием:** убедиться, что исходный файл существует, и использовать ТОЛЬКО `mv` через `run_terminal_cmd`
   - Если файл с `-DONE` уже существует → редактировать его, а не создавать новый

4. **Алгоритм переименования стори в DONE:**
   ```
   1. Прочитать существующий файл (например, `1-us-стори.md`)
   2. Обновить критерии готовности через `search_replace` (пометить как выполненные)
   3. Проверить через `list_dir`, что файла с `-DONE` еще нет
   4. Выполнить `run_terminal_cmd` с командой `mv "путь/к/файлу.md" "путь/к/файлу-DONE.md"`
   5. НИКОГДА не использовать `write` для создания файла с `-DONE`
   ```

## Автоматическое обновление документации и тестов

### При изменении функционала - ОБЯЗАТЕЛЬНО обновить:

1. **Unit тесты (`tests/`)**
   - При изменении логики: обновить существующие тесты или добавить новые
   - При исправлении бага: добавить тест, который воспроизводит баг и проверяет исправление
   - Всегда запускать `npm test` после изменений

2. **E2E тесты (`e2e/`)**
   - При изменении критического функционала: обновить или добавить e2e тесты
   - При изменении UI/UX: обновить соответствующие e2e тесты

3. **Тест-кейсы (`Releases/test-cases/modules/`)**
   - При изменении поведения: обновить ожидаемые результаты в тест-кейсах
   - При добавлении нового функционала: добавить новые тест-кейсы
   - Найти соответствующий файл модуля и обновить его

4. **API документация (`docs/public-docs/`)**
   - При изменении API endpoints: обновить `api-inventory.md` и `no-code-blocks-api-guide.md`
   - При изменении форматов запросов/ответов: обновить примеры в документации

5. **Пользовательская документация (`Releases/user-guide/`)**
   - При изменении пользовательского функционала: обновить соответствующий файл в `Releases/user-guide/`
   - При добавлении новых возможностей: добавить описание в user-guide
   - Все ссылки должны использовать формат Confluence: `https://wiki.hopper-it.ru/display/AI/{filename}?src=contextnavpagetreemode`

### Процесс работы:

**При изменении кода:**
1. Сначала внести изменения в код
2. Автоматически проверить, какие файлы документации/тестов нужно обновить
3. Предложить пользователю: "Обновить документацию и тесты для этих изменений?"
4. Если пользователь согласен - выполнить обновления:
   - Обновить тесты
   - Обновить тест-кейсы
   - Обновить документацию
   - Проверить ссылки в user-guide (формат Confluence)

**При создании нового функционала:**
1. Создать код
2. Создать тесты
3. Спросить: "Добавить тест-кейсы и обновить документацию?"
4. Если да - добавить тест-кейсы в соответствующий модуль и обновить документацию

**При исправлении бага:**
1. Исправить код
2. Добавить тест, который воспроизводит баг
3. Спросить: "Обновить тест-кейсы и документацию?"
4. Если да - обновить тест-кейсы (если баг был найден при тестировании) и документацию (если поведение изменилось)

### Маппинг изменений к документации:

**Изменения в `server/routes.ts` (API endpoints):**
- → Обновить `docs/public-docs/api-inventory.md`
- → Обновить `docs/public-docs/no-code-blocks-api-guide.md` (если касается no-code)
- → Обновить тесты в `tests/` и `e2e/`

**Изменения в `client/src/pages/` (UI):**
- → Обновить соответствующий файл в `Releases/user-guide/`
- → Обновить тест-кейсы в `Releases/test-cases/modules/`
- → Обновить e2e тесты в `e2e/`

**Изменения в no-code функционале:**
- → Обновить `Releases/user-guide/no-code-integration.md`
- → Обновить `Releases/test-cases/modules/no-code-integration.md`
- → Обновить `docs/public-docs/no-code-blocks-api-guide.md`

**Изменения в админке:**
- → Обновить `Releases/user-guide/admin-panel.md`
- → Обновить `Releases/test-cases/modules/admin-panel.md`

**Изменения в аутентификации/регистрации:**
- → Обновить `Releases/user-guide/getting-started.md` (если меняется процесс регистрации)
- → Обновить `Releases/test-cases/modules/authentication.md`

**Изменения в работе с файлами:**
- → Обновить `Releases/user-guide/files.md`
- → Обновить `Releases/test-cases/modules/files.md`

**Изменения в навыках:**
- → Обновить `Releases/user-guide/skills.md`
- → Обновить `Releases/test-cases/modules/skills.md`

**Изменения в чатах:**
- → Обновить `Releases/user-guide/chats.md`
- → Обновить `Releases/test-cases/modules/chats.md`

### Формат ссылок в user-guide:

Все ссылки на другие документы в `Releases/user-guide/` должны использовать формат Confluence:
- `[текст](https://wiki.hopper-it.ru/display/AI/filename?src=contextnavpagetreemode)`
- С якорем: `[текст](https://wiki.hopper-it.ru/display/AI/filename?src=contextnavpagetreemode#anchor)`
- Без расширения `.md` в имени файла

### Автоматические действия:

**После изменения кода:**
1. Проанализировать изменения
2. Определить, какие файлы документации/тестов затронуты
3. Спросить пользователя: "Обновить документацию и тесты для этих изменений? (файлы: ...)"
4. Если пользователь согласен - выполнить обновления автоматически

**При коммите изменений:**
- Проверить, что все связанные файлы обновлены
- Если нет - напомнить и предложить обновить

### Важные правила:

1. **Всегда обновлять тесты вместе с кодом** - не оставлять устаревшие тесты
2. **Тест-кейсы должны отражать реальное поведение** - если поведение изменилось, обновить ожидаемые результаты
3. **Документация должна быть актуальной** - если API изменился, документация должна быть обновлена немедленно
4. **Ссылки в user-guide всегда в формате Confluence** - проверять при любых изменениях
5. **Версии в тест-кейсах должны соответствовать текущему релизу** - проверять версию в заголовке

### Примеры автоматических действий:

**Пример 1: Изменен API endpoint**
```
Пользователь: изменил POST /api/chat/actions
AI: "Обнаружено изменение API endpoint. Обновить документацию и тесты?
- docs/public-docs/api-inventory.md
- tests/bot-action-api.test.ts
- Releases/test-cases/modules/chats.md"
Пользователь: "да"
AI: [выполняет обновления]
```

**Пример 2: Изменен UI компонент**
```
Пользователь: изменил ChatPage.tsx
AI: "Обнаружено изменение UI. Обновить документацию и тест-кейсы?
- Releases/user-guide/chats.md
- Releases/test-cases/modules/chats.md
- e2e/chat.spec.ts"
Пользователь: "да"
AI: [выполняет обновления]
```

### Чеклист перед коммитом:

Перед каждым коммитом проверять:
- [ ] Код изменен
- [ ] Тесты обновлены/добавлены
- [ ] Тест-кейсы актуальны
- [ ] Документация обновлена
- [ ] Ссылки в user-guide в формате Confluence
- [ ] Все тесты проходят

Если что-то не выполнено - предложить выполнить перед коммитом.

